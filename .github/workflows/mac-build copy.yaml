name: ğŸ æ„å»º macOS åº”ç”¨

on:
  workflow_dispatch:
  # push:
  #   tags:
  #     - 'v*'   # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build:
    runs-on: self-hosted  # æ›´æ”¹ä¸ºæ”¯æŒ M1 çš„è¿è¡Œå™¨
    permissions:
      contents: write
      packages: write
    
    env:
      FLUTTER_VERSION: main
      FLUTTER_CHANNEL: main
      RUST_VERSION: 1.89.0
    
    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: ğŸ¦€ è®¾ç½® Rust å·¥å…·é“¾ ${{ env.RUST_VERSION }}
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/install_rust.sh
          $GITHUB_WORKSPACE/scripts/install_rust.sh
          rustup target add aarch64-apple-darwin  # æ·»åŠ  ARM æ¶æ„æ”¯æŒ

      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          brew update
          brew install cmake ninja
          brew install protobuf
          brew install ruby
          brew install cocoapods
          export LDFLAGS="-L/opt/homebrew/opt/ruby/lib"
          export CPPFLAGS="-I/opt/homebrew/opt/ruby/include"

      - name: ğŸ¦ å®‰è£… Flutter
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/install_flutter.sh
          $GITHUB_WORKSPACE/scripts/install_flutter.sh

      - name: ğŸ¯ å¯ç”¨ macOS æ¡Œé¢æ”¯æŒ
        run: |
          flutter config --enable-macos-desktop
          flutter create --platforms=macos .

      - name: ğŸ“š å®‰è£… Flutter ä¾èµ–
        run: |
          flutter pub get

      - name: ğŸ› ï¸ æ„å»º macOS åº”ç”¨
        run: |
          flutter build macos --release --dart-define=FLUTTER_APP_ARCH=arm64  # æŒ‡å®š ARM64 å¹³å°

      - name: ğŸ“¦ æ‰“åŒ…åº”ç”¨
        run: |
          mkdir -p release
          cd build/macos/Build/Products/Release
          # åˆ›å»º DMG æ–‡ä»¶
          hdiutil create -volname "Astral" -srcfolder astral.app -ov -format UDZO $GITHUB_WORKSPACE/release/astral-macos-arm64.dmg
          echo "æ‰“åŒ…å®Œæˆï¼Œæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼š"
          ls -lh $GITHUB_WORKSPACE/release/

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-release
          path: release/astral-macos-arm64.dmg
          retention-days: 7