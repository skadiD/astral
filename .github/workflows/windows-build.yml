name: ğŸªŸ æ„å»º Windows åº”ç”¨

on:
  workflow_dispatch:
  push:  # æ¯æ¬¡ push åˆ°ä»“åº“æ—¶è§¦å‘
    tags:
      - 'v*'   # æŒ‡å®šè§¦å‘åˆ†æ”¯

jobs:
  build:
    runs-on: windows-latest

    # è°ƒæ•´ GITHUB_TOKEN çš„æƒé™
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰
      packages: write
      
    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      # å®‰è£… Rust
      - name: ğŸ¦€ å®‰è£… Rust 1.89.0
        run: |
          # å…ˆæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§ç‰ˆæœ¬
          if (Get-Command rustup -ErrorAction SilentlyContinue) {
            Write-Host "å¸è½½ç°æœ‰Rustå®‰è£…..."
            rustup self uninstall -y
          }
          
          # é€šè¿‡rustupå®‰è£…æŒ‡å®šç‰ˆæœ¬çš„Rust
          Write-Host "ä¸‹è½½å¹¶å®‰è£…Rust 1.89.0..."
          curl.exe -sSf https://sh.rustup.rs -o rustup-init.exe
          .\rustup-init.exe -y --default-toolchain 1.89.0 --profile minimal
          Remove-Item .\rustup-init.exe
          
          # å°†Rustæ·»åŠ åˆ°PATHå¹¶åŠ è½½ç¯å¢ƒ
          $env:PATH = "$env:USERPROFILE\.cargo\bin;" + $env:PATH
          echo "$env:USERPROFILE\.cargo\bin" >> $env:GITHUB_PATH
          
          # åŠ è½½rustç¯å¢ƒ
          if (Test-Path "$env:USERPROFILE\.cargo\env.ps1") {
            . "$env:USERPROFILE\.cargo\env.ps1"
          }
        shell: pwsh

      # éªŒè¯ Rust å®‰è£…
      - name: ğŸ” éªŒè¯ Rust å®‰è£…
        run: |
          # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å·¥å…·é“¾
          rustup default 1.89.0
          
          # éªŒè¯ç‰ˆæœ¬
          Write-Host "Rust ç‰ˆæœ¬ï¼š"
          rustc --version
          Write-Host "Cargo ç‰ˆæœ¬ï¼š"
          cargo --version
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "CARGO_NET_GIT_FETCH_WITH_CLI=true" >> $env:GITHUB_ENV
          echo "RUST_BACKTRACE=1" >> $env:GITHUB_ENV
        shell: pwsh

      # å®‰è£… Flutter
      - name: ğŸ¦ å®‰è£… Flutter
        run: |
          echo "æ­£åœ¨å…‹éš† Flutter ç¨³å®šåˆ†æ”¯..."
          git clone https://github.com/flutter/flutter.git --branch 3.29.3 $env:GITHUB_WORKSPACE/flutter --depth 1

          echo "æ­£åœ¨å°† Flutter æ·»åŠ åˆ° PATH..."
          echo "$env:GITHUB_WORKSPACE/flutter/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          echo "Flutter ç‰ˆæœ¬éªŒè¯ï¼š"
          & "$env:GITHUB_WORKSPACE/flutter/bin/flutter.bat" --version
        shell: pwsh

      # å®‰è£…æ„å»ºå·¥å…·
      - name: ğŸ› ï¸ å®‰è£…æ„å»ºå·¥å…·
        run: |
          choco install ninja cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          echo "CMake ç‰ˆæœ¬éªŒè¯ï¼š"
          cmake --version
        shell: pwsh

      # å®‰è£… Flutter ä¾èµ–
      - name: ğŸ“¦ å®‰è£… Flutter ä¾èµ–
        run: |
          echo "æ­£åœ¨è·å– Flutter ä¾èµ–..."
          flutter pub get
          echo "Flutter ä¾èµ–å®‰è£…å®Œæˆï¼"
        shell: pwsh

      # ç¼–è¯‘ Flutter Windows åº”ç”¨
      - name: ğŸ› ï¸ ç¼–è¯‘ Flutter Windows åº”ç”¨
        run: |
          echo "æ­£åœ¨ç¼–è¯‘ Flutter Windows Release ç‰ˆæœ¬..."
          flutter build windows --release --verbose
          echo "Flutter Windows Release ç¼–è¯‘å®Œæˆï¼"
        shell: pwsh

      # å¤åˆ¶ DLL æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
      - name: ğŸ“‚ å¤åˆ¶ DLL æ–‡ä»¶åˆ° Release ç›®å½•
        run: |
          echo "æ­£åœ¨å¤åˆ¶ DLL æ–‡ä»¶åˆ° Release ç›®å½•..."
          $dllSourceDir = "$env:GITHUB_WORKSPACE\dlls"
          $releaseDir = "$env:GITHUB_WORKSPACE\build\windows\x64\runner\Release"
          Copy-Item -Path "$dllSourceDir\*" -Destination $releaseDir -Recurse -Force
          echo "DLL æ–‡ä»¶å·²å¤åˆ¶åˆ° $releaseDirï¼"

      # å‹ç¼© Release ç›®å½•
      - name: ğŸ“¦ å‹ç¼© Release ç›®å½•
        run: |
          echo "æ­£åœ¨å‹ç¼© Release ç›®å½•..."
          $releaseDir = "$env:GITHUB_WORKSPACE\build\windows\x64\runner\Release"
          $zipFile = "$env:GITHUB_WORKSPACE\astral-windows-x64-zip.zip"
          Compress-Archive -Path "$releaseDir\*" -DestinationPath $zipFile -Force
          echo "Release ç›®å½•å·²å‹ç¼©ä¸º $zipFileï¼"

      # ä¸Šä¼ å‹ç¼©åçš„ Release ç›®å½•ä½œä¸º Artifact
      - name: ğŸ“¤ ä¸Šä¼ å‹ç¼©åçš„ Release ç›®å½•
        uses: actions/upload-artifact@v4
        with:
          name: astral-windows-x64-zip
          path: ${{ github.workspace }}/astral-windows-x64-zip.zip