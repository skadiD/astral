name: ğŸš€ å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'åŸºç¡€åˆ†æ”¯ (ä¾‹å¦‚: v0.0.0)'
        required: true
        default: 'v1.'
        type: string
      head_branch:
        description: 'ç›®æ ‡åˆ†æ”¯ (ä¾‹å¦‚: main)'
        required: true
        default: 'main'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    # è°ƒæ•´ GITHUB_TOKEN çš„æƒé™
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰
      actions: read    # å…è®¸è¯»å–å·¥ä½œæµç¨‹

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œä»¥ä¾¿æ¯”è¾ƒåˆ†æ”¯
        
      - name: ğŸ“¦ ä¸‹è½½ arm64-v8a æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "android-build-arm64.yaml"
          name: astral-arm64-v8a-apk
          path: ./downloaded/arm64-v8a
          search_artifacts: true
          if_no_artifact_found: warn
      - run: mv ./downloaded/arm64-v8a/* ./downloaded/arm64-v8a/astral-arm64-v8a.apk

      - name: ğŸ“¦ ä¸‹è½½ armeabi-v7a æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "android-build-armv7.yaml"
          name: astral-armeabi-v7a-apk
          path: ./downloaded/armeabi-v7a
          search_artifacts: true
          if_no_artifact_found: warn
      - run: mv ./downloaded/armeabi-v7a/* ./downloaded/armeabi-v7a/astral-armeabi-v7a.apk

      - name: ğŸ“¦ ä¸‹è½½ Universal APK æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "android-build-universal.yaml"
          name: astral-universal-apk
          path: ./downloaded/universal
          search_artifacts: true
          if_no_artifact_found: warn

      - name: ğŸ“¦ ä¸‹è½½ WindowsSetup æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "windows-build-Setup.yml"
          name: astral-windows-x64-setup
          path: ./downloaded/WindowsSetup
          search_artifacts: true
          if_no_artifact_found: warn

      - name: ğŸ“¦ ä¸‹è½½ Windows zip æ„ä»¶æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: "windows-build.yml"
          name: astral-windows-x64-zip
          path: ./downloaded/windows
          search_artifacts: true
          if_no_artifact_found: warn

      - name: ğŸ“¦ ä¸‹è½½ linux æ„ä»¶
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: 'linux-build.yaml'
          name: astral-linux-x64-all
          path: ./downloaded/linux
          search_artifacts: true
          if_no_artifact_found: warn

      - name: ğŸ“ åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
        run: |
          echo "å·²ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨:"
          ls -la ./downloaded
          echo "armeabi-v7a æ–‡ä»¶:"
          ls -la ./downloaded/armeabi-v7a || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "arm64-v8a æ–‡ä»¶:"
          ls -la ./downloaded/arm64-v8a || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "universal APK æ–‡ä»¶:"
          ls -la ./downloaded/universal || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "Windows æ–‡ä»¶:"
          ls -la ./downloaded/windows || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "WindowsSetup æ–‡ä»¶:"
          ls -la ./downloaded/WindowsSetup || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "Linux æ–‡ä»¶:"
          ls -la ./downloaded/linux || echo "ç›®å½•ä¸å­˜åœ¨"
          
      - name: ğŸ¤– ç”Ÿæˆåˆ†æ”¯å·®å¼‚æäº¤å†…å®¹ï¼ˆè‡ªåŠ¨æ£€æµ‹å¯ç”¨ Gemini æ¨¡å‹ï¼‰
        id: generate_changelog
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE }}
        run: |
          # 1ï¸âƒ£ è·å–ä¸¤ä¸ªåˆ†æ”¯ä¹‹é—´çš„æäº¤ä¿¡æ¯
          COMMITS=$(git log --pretty=format:"%h - %s (%an)" ${{ github.event.inputs.base_branch }}..${{ github.event.inputs.head_branch }})
          echo "$COMMITS" > commits.txt

          # 2ï¸âƒ£ å®‰è£…ä¾èµ–
          pip install google-generativeai

          # 3ï¸âƒ£ å…ˆåˆ—å‡ºå½“å‰ KEY çœŸæ­£å¯ç”¨çš„æ¨¡å‹ï¼ˆè‡ªåŠ¨é€‰ç¬¬ä¸€ä¸ªå¯ç”¨çš„ï¼‰
          cat > generate_changelog.py << 'EOF'
          import google.generativeai as genai
          import os
          import sys

          api_key = os.environ.get("GOOGLE_API_KEY")
          if not api_key:
              print("âŒ ç¼ºå°‘ GOOGLE_API_KEY")
              sys.exit(1)

          genai.configure(api_key=api_key)

          print("âœ… æ­£åœ¨æ£€æµ‹å¯ç”¨æ¨¡å‹...")

          models = [
              m.name for m in genai.list_models()
              if "generateContent" in m.supported_generation_methods
          ]

          if not models:
              print("âŒ å½“å‰ Key æ²¡æœ‰ä»»ä½•å¯ç”¨çš„ Gemini æ¨¡å‹")
              sys.exit(1)

          model_name = models[0]
          print(f"âœ… ä½¿ç”¨æ¨¡å‹: {model_name}")

          # 4ï¸âƒ£ è¯»å–æäº¤è®°å½•
          with open("commits.txt", "r") as f:
              commits = f.read().strip()

          if not commits:
              with open("CHANGELOG.md", "w", encoding="utf-8") as f:
                  f.write("æœ¬æ¬¡æ›´æ–°æœªåŒ…å«åŠŸèƒ½å˜æ›´")
              print("âœ… æ— æäº¤è®°å½•ï¼Œå·²ç”Ÿæˆç©ºæ—¥å¿—")
              sys.exit(0)

          # 5ï¸âƒ£ æ„å»º Prompt
          prompt = f"""
          è¯·æ ¹æ®ä»¥ä¸‹Gitæäº¤è®°å½•ç”Ÿæˆé¢å‘æ™®é€šç”¨æˆ·çš„æ›´æ–°è¯´æ˜ï¼š

          ## æäº¤è®°å½•
          {commits}

          ç”Ÿæˆè¦æ±‚ï¼š
          1. ä½¿ç”¨çº¯æ–‡æœ¬æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ä»»ä½•Markdownæ ‡è®°ï¼ˆå¦‚#ã€*ã€-ã€>ç­‰ï¼‰
          2. è¯­æ°”æ­£å¼ã€ä¸“ä¸šï¼Œé¢å‘æœ€ç»ˆç”¨æˆ·
          3. å¼€å¤´ç”¨ä¸€å¥è¯æ¦‚æ‹¬æœ¬æ¬¡æ›´æ–°çš„æ ¸å¿ƒå†…å®¹
          4. ç„¶åç©ºä¸€è¡Œ
          5. æŒ‰ä»¥ä¸‹æ ¼å¼åˆ†ç±»è¯´æ˜ï¼š
          
             ã€æ–°å¢åŠŸèƒ½ã€‘
             Â· åŠŸèƒ½æè¿°1
             Â· åŠŸèƒ½æè¿°2
             
             ã€é—®é¢˜ä¿®å¤ã€‘
             Â· ä¿®å¤æè¿°1
             Â· ä¿®å¤æè¿°2
             
             ã€æ€§èƒ½ä¼˜åŒ–ã€‘
             Â· ä¼˜åŒ–æè¿°1
             Â· ä¼˜åŒ–æè¿°2
          
          6. å†…å®¹æ’°å†™è§„èŒƒï¼š
             - ä½¿ç”¨ä¸­æ–‡åœ†ç‚¹ç¬¦å·ï¼ˆÂ·ï¼‰ä½œä¸ºåˆ—è¡¨æ ‡è®°
             - æ¯æ¡è¯´æ˜ç®€æ´æ˜äº†ï¼Œé¿å…æŠ€æœ¯æœ¯è¯­
             - ä½¿ç”¨ç”¨æˆ·èƒ½ç†è§£çš„è¯­è¨€æè¿°åŠŸèƒ½å˜åŒ–
             - ç›¸ä¼¼çš„æ”¹åŠ¨åˆå¹¶ä¸ºä¸€æ¡
             - å¦‚æœæŸä¸ªåˆ†ç±»æ²¡æœ‰å†…å®¹å°±ä¸è¦æ˜¾ç¤ºè¯¥åˆ†ç±»
             - æ¯ä¸ªåˆ†ç±»ä¹‹é—´ç©ºä¸€è¡Œ
          
          7. æ³¨æ„äº‹é¡¹ï¼š
             - ä¸è¦åŒ…å«å¼€å‘è€…ä¿¡æ¯ã€commit hashç­‰æŠ€æœ¯ç»†èŠ‚
             - æè¿°è¦è®©éæŠ€æœ¯ç”¨æˆ·ä¹Ÿèƒ½ç†è§£
             - çªå‡ºç”¨æˆ·å¯æ„ŸçŸ¥çš„å˜åŒ–
          """

          # 6ï¸âƒ£ ç”Ÿæˆæ—¥å¿—
          model = genai.GenerativeModel(model_name)
          response = model.generate_content(prompt)

          with open("CHANGELOG.md", "w", encoding="utf-8") as f:
              f.write(response.text)

          print("âœ… æ›´æ–°æ—¥å¿—ç”Ÿæˆå®Œæˆ")
          EOF

          # 7ï¸âƒ£ æ‰§è¡Œç”Ÿæˆè„šæœ¬
          python generate_changelog.py

          # 8ï¸âƒ£ è¾“å‡ºç»™ GitHub Release ä½¿ç”¨
          CHANGELOG=$(cat CHANGELOG.md)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          
      - name: ğŸš€ åˆ›å»ºè‰ç¨¿å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          name: å‘å¸ƒ ${{ github.event.inputs.head_branch }}
          tag_name: release-${{ github.run_number }}
          body: ${{ steps.generate_changelog.outputs.changelog }}
          draft: true  # è®¾ç½®ä¸ºè‰ç¨¿çŠ¶æ€
          prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          files: |
            ./downloaded/arm64-v8a/*.apk
            ./downloaded/armeabi-v7a/*.apk
            ./downloaded/universal/*.apk
            ./downloaded/WindowsSetup/*.exe
            ./downloaded/windows/*.zip
            ./downloaded/linux/astral-linux-x64.tar.gz
            ./downloaded/linux/astral-linux-x64.deb
            ./downloaded/linux/astral-linux-x64.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
